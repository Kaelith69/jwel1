<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Firebase Health Check</title>
  <link rel="stylesheet" href="styles-consistent.css" />
  <link rel="stylesheet" href="neumorphic.css" />
    <style>
      body { max-width: 900px; margin: 2rem auto; padding: 1rem; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
      h1 { font-size: 1.5rem; }
      .ok { color: #0a7f2e; font-weight: 600; }
      .warn { color: #9a6700; font-weight: 600; }
      .err { color: #d1242f; font-weight: 600; }
      code { background: #f6f8fa; padding: 0.15rem 0.35rem; border-radius: 4px; }
      .card { border: 1px solid #eaecef; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 0.95rem; }
      .small { font-size: 0.9rem; color: #57606a; }
      ul { padding-left: 1.25rem; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 0.75rem; }
      @media (min-width: 700px) { .grid { grid-template-columns: 1fr 1fr; } }
    </style>
  </head>
  <body>
    <h1>Firebase Health Check</h1>
    <p class="small">This page verifies Firebase SDK init, Firestore reads, and expected write permissions using your <code>js/firebase-config.js</code>.</p>

    <div class="card">
      <div id="summary" class="mono">Running checksâ€¦</div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>SDK</h3>
        <ul id="sdk"></ul>
      </div>
      <div class="card">
        <h3>Auth</h3>
        <ul id="auth"></ul>
      </div>
      <div class="card">
        <h3>Firestore</h3>
        <ul id="fs"></ul>
      </div>
      <div class="card">
        <h3>Adapter</h3>
        <ul id="ad"></ul>
      </div>
    </div>

    <script type="module">
      const el = (id) => document.getElementById(id);
      const li = (cls, text) => {
        const item = document.createElement('li');
        if (cls) item.className = cls;
        item.textContent = text;
        return item;
      };

      const sdkEl = el('sdk');
      const authEl = el('auth');
      const fsEl = el('fs');
      const adEl = el('ad');
      const sumEl = el('summary');

      const setSummary = (parts) => {
        sumEl.textContent = parts.filter(Boolean).join(' | ');
      };

      (async () => {
        const summaryBits = [];
        let allOk = true;

        try {
          const cfg = await import('./js/firebase-config.js');
          const res = await cfg.initFirebaseIfNeeded();
          const app = cfg.app;
          const db = cfg.db;
          const auth = cfg.auth;
          const storage = cfg.storage;

          if (app) {
            sdkEl.appendChild(li('ok', 'App initialized'));
            summaryBits.push('SDK: OK');
          } else {
            sdkEl.appendChild(li('err', 'App not initialized'));
            summaryBits.push('SDK: FAIL');
            allOk = false;
          }
          sdkEl.appendChild(li('', `Project: ${(res?.app?.options?.projectId) || 'unknown'}`));
          sdkEl.appendChild(li('', `Storage: ${storage ? 'available' : 'not available'}`));

          if (auth) {
            authEl.appendChild(li('ok', 'Auth instance available'));
            try {
              const authMod = await import('https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js');
              let resolved = false;
              await new Promise((resolve) => {
                authMod.onAuthStateChanged(auth, (user) => {
                  resolved = true;
                  const s = user ? `Signed in as ${user.email || user.uid}` : 'Not signed in';
                  authEl.appendChild(li(user ? 'ok' : 'warn', s));
                  summaryBits.push(user ? 'Auth: signed-in' : 'Auth: no-user');
                  resolve();
                }, resolve);
                setTimeout(() => !resolved && resolve(), 4000);
              });
            } catch (err) {
              authEl.appendChild(li('warn', `Auth helper import failed: ${err?.message || err}`));
              summaryBits.push('Auth: helper error');
            }
          } else {
            authEl.appendChild(li('warn', 'Auth not configured (expected unless you enabled it)'));
            summaryBits.push('Auth: not-configured');
          }

          if (db) {
            try {
              const fsMod = await import('https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js');
              const qsnap = await fsMod.getDocs(fsMod.collection(db, 'products'));
              fsEl.appendChild(li('ok', `Read products: ${qsnap.size} document(s)`));
              summaryBits.push('FS Read: OK');
            } catch (err) {
              fsEl.appendChild(li('err', `Failed to read products: ${err?.code || err?.message || err}`));
              summaryBits.push('FS Read: FAIL');
              allOk = false;
            }

            try {
              const fsMod = await import('https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js');
              const docRef = await fsMod.addDoc(fsMod.collection(db, 'health_checks'), { at: new Date().toISOString(), ok: true });
              fsEl.appendChild(li('warn', `Write allowed (doc ${docRef.id}); you may be signed in with elevated privileges`));
              summaryBits.push('FS Write: allowed');
            } catch (err) {
              const code = err?.code || err?.message || String(err);
              const permissionBlocked = typeof code === 'string' && code.includes('permission');
              fsEl.appendChild(li(permissionBlocked ? 'ok' : 'err', permissionBlocked ? 'Write blocked as expected for non-admin' : `Write failed: ${code}`));
              summaryBits.push(permissionBlocked ? 'FS Write: blocked (expected)' : 'FS Write: error');
              if (!permissionBlocked) {
                allOk = false;
              }
            }
          } else {
            fsEl.appendChild(li('err', 'Firestore not initialized'));
            summaryBits.push('FS: FAIL');
            allOk = false;
          }

          try {
            const adapterMod = await import('./js/firebase-adapter.js');
            const adapter = adapterMod.default || adapterMod;
            const state = await adapter.init();
            adEl.appendChild(li(state.useFirestore ? 'ok' : 'warn', `Adapter using ${state.useFirestore ? 'Firestore' : 'localStorage'} backend`));
            try {
              const products = await adapter.getProducts();
              adEl.appendChild(li('ok', `Adapter getProducts(): ${Array.isArray(products) ? products.length : 0} item(s)`));
            } catch (err) {
              adEl.appendChild(li('err', `Adapter getProducts failed: ${err?.message || err}`));
              summaryBits.push('Adapter: read fail');
              allOk = false;
            }
          } catch (err) {
            adEl.appendChild(li('err', `Adapter import failed: ${err?.message || err}`));
            summaryBits.push('Adapter: crash');
            allOk = false;
          }
        } catch (err) {
          sdkEl.appendChild(li('err', `Health check crashed: ${err?.message || err}`));
          summaryBits.push('Health: crash');
          allOk = false;
        }

        const finalSummary = [`Overall: ${allOk ? 'PASS' : 'FAIL'}`].concat(summaryBits).join(' | ');
        setSummary([finalSummary]);

        try {
          const q = encodeURIComponent(finalSummary);
          fetch(`/__health_status__?s=${q}`).catch(() => {});
        } catch {}
      })();
    </script>
  </body>
</html>
